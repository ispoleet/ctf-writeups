// ------------------------------------------------------------------------------------------------
// PhDays quals 2014 - MyFavoriteMalware (RE 4000)
// ------------------------------------------------------------------------------------------------
#include <idc.idc>

// ------------------------------------------------------------------------------------------------
static main() 
{
    auto target, name, flags, xref, newname, var, base;
    
    flags = SEARCH_DOWN | SEARCH_NEXT;

    // base = 0x013CD000;                           // where "GOT" starts (myfavoritemalware.exe)
    base = 0x1000B000;                              // where "GOT" starts (mswow64.exe)
    /*
     * First we run the code in order to let IDA set the DATA XREFs. Then we'll have code 
     * like this:
     *      UPX0:011BD000 off_11BD000 dd offset advapi32_OpenServiceW ;
     *      UPX0:011BD000 off_11BD004 dd offset advapi32_CloseServiceHandle ;
     *
     * Our goal is to rename off_11BD000 to advapi32_OpenServiceW to make code more readable
     */
    // for (var=base; var<=base + 0x1B0; var=FindData(var, flags))    
    for (var=base; var<=base + 0x15c; var=FindData(var, flags))
    {
        name = Name(var);

        Message("Next DXREF at %x (%s)\n", var, name);
        
        for( target=Dfirst(var); target!=BADADDR; target=Dnext(var, target) ) 
        {
            xref = XrefType();
            
            if( xref == dr_O ) {                    // xref type: offset
                newname = Name(target);                           
                newname = sprintf("%s_v6", newname );

                Message("Variable %s becomes: %s\n",  Name(var), newname);
                MakeNameEx(var, newname, SN_NOCHECK);               
            }
        }
    }
}
// ------------------------------------------------------------------------------------------------
/*
Sample output:

Next DXREF at 13cd000 (off_13CD000)
Variable off_13CD000 becomes: advapi32_OpenServiceW
Next DXREF at 13cd004 (off_13CD004)
Variable off_13CD004 becomes: advapi32_CloseServiceHandle
Next DXREF at 13cd008 (off_13CD008)
Variable off_13CD008 becomes: unk_70FE1C53
13CD008: can't rename byte as 'unk_70FE1C53' because the name has a reserved prefix.
Next DXREF at 13cd00c (off_13CD00C)
Variable off_13CD00C becomes: advapi32_ChangeServiceConfig2W
...
*/
// ------------------------------------------------------------------------------------------------
