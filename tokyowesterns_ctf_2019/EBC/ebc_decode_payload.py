#!/usr/bin/env python2
# --------------------------------------------------------------------------------------------------
# Tokyo Westerns CTF 2019 - EBC (RE 232)
# --------------------------------------------------------------------------------------------------
import struct
import os
import sys
import zlib
import shutil

payload_stage_1 = [ 
    0x16D1DAAD, 0x2E21693A, 0x736BCE3B, 0x3524E090, 0xC0A02046, 0xD5D973A3, 0x57866F3A, 0x55DE06A5,
    0x33244037, 0xD4DB6898, 0xA44F167E, 0x57E76D3A, 0x0B50E932, 0x3124F0C7, 0xE5BAF0F0, 0x6182D8F4,
    0x579E3A81, 0x547D6C3A, 0x9E179079, 0x778581DF, 0x77853A80, 0x279E7A81, 0x6B39683A, 0xE091410B,
    0x7785133D, 0x67853A80, 0x379E0A81, 0x17990A81, 0x9C4C6D3A, 0xFFF11A10, 0x778518CE, 0x33247A80,
    0x46149A94, 0xE67A1DBA, 0x779E1A80, 0xF32E6D3A, 0xAD2F2DD5, 0x17990325, 0x78BA6D3A, 0x97686D75,
    0x579F6ACA, 0x479E4A86, 0x5A196D3A, 0x6BE3C434, 0x6785B635, 0x479F7A80, 0x32246A9B, 0x767B7AD6,
    0x9250AE85, 0x679E1A9B, 0x38F96D3A, 0x50712E38, 0x779EEA61, 0x1D796E3A, 0xB09CC3D0, 0x2785B348,
    0x30246A80, 0x4BF2EB06, 0x0BB335C6, 0x57856A81, 0xA0B76C3A, 0x4A86D4B5, 0x179924C6, 0xCD066C3A,
    0x3DE6E06D, 0x6785C64F, 0xEE5B6D3A, 0x3D1762C7, 0x6785FE18, 0x897C6D3A, 0x15525820, 0x779EB395,
    0xF8EC683A, 0xD7D5FFB6, 0x379EB2B7, 0x30244A87, 0x37663668, 0x143AD8D0, 0x17984A87, 0x88546F3A,
    0xF497D717, 0x779EB522, 0x31242A81, 0xDEBD5A2D, 0xDF25E76A, 0x679E1A80, 0x213B6D3A, 0xF1800409,
    0x479E96CA, 0x46ED6F3A, 0xD122F77A, 0x479F81BA, 0x7F8A6E3A, 0xF09F73BD, 0x779E3137, 0x31241A81,
    0x8D21E2C2, 0xC7724632, 0x279E4A86, 0x30243A81, 0x93725982, 0x91B70895, 0x17996A9B, 0x279F0A9B,
    0x17992A9B, 0x342E6E3A, 0x2616AF14, 0x579F6D5E, 0x34241A80, 0xCB8DF1EB, 0x983E2DFA, 0x30244A86,
    0x643FCDB5, 0x7D285A92, 0x17984A87, 0x37853A81, 0xFBDA6D3A, 0xFA20E933, 0x1799720C, 0x0C0E683A,
    0xE9BC01C7, 0x279F446A, 0x31240A80, 0x5A93FE0A, 0xB04D7676, 0x17990A9B, 0x779E4A86, 0x57856A81,
    0x30247A81, 0xE98B6BD0, 0x2518F090, 0x579E1A81, 0x579E1A9B, 0x579E0A81, 0x17981A80, 0xCF16693A,
    0x4C81FF67, 0x3785CA94, 0xD47C683A, 0xA32602DA, 0x1798F662, 0xD6A9693A, 0x8EA734DE, 0x379FD6DF,
    0xBFB66F3A, 0x384B5C1C, 0x378541FE, 0xF68B6D3A, 0x72200C2A, 0x379E648B, 0x7D5F683A, 0xE5E23E8C,
    0x4785B2C6, 0x26556E3A, 0x09CAEC23, 0x6785DF48, 0x33246A81, 0x56968D03, 0x76EBF69F, 0x47850A9B,
    0x32240A81, 0xD03011F7, 0x76ECCE73, 0x479E7A81, 0x779F2A80, 0x579E1A81, 0xFC3E6C3A, 0xFACA6BFF,
    0x7796DB6A, 0x37A4584F, 0x04D15BCC, 0x06D36ABA, 0x06D74CED, 0x14C573F9, 0xC9F6A325, 0x73052A56
]

payload_stage_2 = [
    0x53479A05, 0x6BB72992, 0x36FD8E93, 0x70B2A038, 0x853660EE, 0x904F330B, 0x12102F92, 0x1048460D,
    0x76B2009F, 0x914D2830, 0xE1D956D6, 0x12712D92, 0x4EC6A99A, 0x74B2B06F, 0xA02CB058, 0x2414985C,
    0x12137A28, 0x11EB2C92, 0xDB81D0D1, 0x5465C177, 0x43622E12, 0x76324C32, 0x121D1B7C, 0x74B26A30,
    0xD08CD39B, 0x85416A32, 0xB33D2E92, 0x4F0016A2, 0x7208B791, 0x22752C92, 0xA5D3D73C, 0x520F8AF1,
    0x70320E45, 0x761D1B66, 0x43782812, 0x12102A32, 0xF4522E92, 0x1CB09DB3, 0x70B29C2D, 0x853E6F87,
    0xEAE78729, 0x74320E45, 0x36121B67, 0x437B2C12, 0x12106A3D, 0x8BAD2E92, 0xD9DABE6D, 0x74B25AB8,
    0x525C135C, 0xF63417BE, 0x71320845, 0x601D1B79, 0x43612912, 0x72103A32, 0xED972892, 0xB6D4913C,
    0x71B2CE04, 0x6526A172, 0x2E169E38, 0x75B26A33, 0x355DEE98, 0x1BADB099, 0x75B20A2E, 0x75FD650C,
    0x72428ADE, 0x22094A28, 0x75320845, 0x20121B4D, 0x435D2D12, 0x72107A3D, 0x56652892, 0x4CDB7186,
    0x75B2F457, 0xF1DC98D9, 0xE254A24B, 0x848D2E92, 0xE0A32A4B, 0x5465BF49, 0x43772E12, 0x76324C3D,
    0x12121B6B, 0x74B26A30, 0x9CFB2007, 0x18967917, 0x625E2E92, 0xB60D6BCD, 0x56658FE6, 0x43752812,
    0x70322E32, 0x721D1B75, 0x76B24A30, 0x43F98669, 0x14E8ECBE, 0xA1A72892, 0xABE7CC39, 0x75B2F5E2,
    0x7D73F586, 0x0E64ABAE, 0x70B27A28, 0xEF096AEF, 0xB0011C9D, 0x57654A28, 0x434F2912, 0x71323F3D,
    0x62121B53, 0x77B25A30, 0x721EB442, 0x6ACB04FB, 0xA8572992, 0x974DD7FC, 0x50656BAB, 0x43522D12,
    0x75327832, 0x221D1B4C, 0x70B22A30, 0x40A894CA, 0xAB1D08E4, 0xCF932D92, 0x7E5C2901, 0x76B20023,
    0xA64C1AC6, 0x4C57097E, 0x76B27A28, 0x3A591E46, 0xFDDEB8FC, 0x76B20A2E, 0x619E37C0, 0x1F212475,
    0x54653A33, 0x43662912, 0x71323C32, 0x621D1B78, 0x74B26A30, 0xA9E0A413, 0x0A39E476, 0x024A2992,
    0xA0F4ABE1, 0x0209F04D, 0xE2602E92, 0x68E274C5, 0x506584ED, 0x436E2F12, 0x77325832, 0x021D1B70,
    0x70B22A30, 0x6C4FA900, 0x73C159D8, 0xCFD72F92, 0x003477B5, 0x55652B02, 0x434B2912, 0x71323D3D,
    0x62121B57, 0x75B27A30, 0xD91EC50A, 0x9444AFC5, 0x44142992, 0xEF7934C4, 0x74B274B6, 0xC8B7A26A,
    0x82E4069A, 0x51650A2E, 0x435A2D12, 0x7532793D, 0x22121B44, 0x71B23A30, 0x908CCB3E, 0xBDA2C298,
    0xF6C22D92, 0x99C91D36, 0x5565DD90, 0x43672912, 0x71323D3D, 0x62121B7B, 0x75B27A30, 0xF124B328,
    0xB062CF4A, 0x7D7C2992, 0xC4217E92, 0x520FE1C1, 0x75320C45, 0x24121B63, 0x437F2D12, 0x32107A3D,
    0x3FF82C92, 0x71B899BD, 0x75B2EFBC, 0x1C687C62, 0x4B00192B, 0x35722892, 0xEE198588, 0x120973C7,
    0x68092F92, 0x2E5582FA, 0x1213FBD8, 0xC9A42C92, 0xAFFA609A, 0x22095AD0, 0x76B27A29, 0x194F11B8,
    0x5CE2F40A, 0x56653A28, 0x43782F12, 0x77325E3D, 0x02121B66, 0x76B24A30, 0x1F05BEA2, 0xF5DB36DE,
    0xA0EB2F92, 0xBF7C256A, 0x321302D0, 0x56652A33, 0x43502912, 0x71323E3D, 0x62121B4E, 0x76B24A30,
    0x608EB038, 0x2EDA4AB0, 0x49EE2992, 0xD2DAD030, 0x77B28A44, 0xC731183B, 0xEBDE26DA, 0x22134A29,
    0x4AF72E92, 0x13C07300, 0x56658B6F, 0x43752F12, 0x77325E32, 0x021D1B75, 0x76B24A30, 0x6EF15C71,
    0x50C1D830, 0x71DF2F92, 0x514F4FCE, 0x12133A72, 0xAAA12E92, 0xFA18047D, 0x2208BCCB, 0x75320E45,
    0x26121B71, 0x43692D12, 0x12107A3D, 0xF2802E92, 0xBC0A79F0, 0x75B2A289, 0xDCE8C55F, 0xC0366EF9,
    0x62080A2E, 0x520F7A29, 0x56650A2F, 0x43742C12, 0x74326E3D, 0x32121B6A, 0x76B24A30, 0xDEA6B275,
    0x913F81B7, 0x3EDE2C92, 0x29584C89, 0x5565F1BF, 0x43622912, 0x71323D32, 0x621D1B7C, 0x75B27A30,
    0x5AE2291C, 0x2CADE9A8, 0xF18C2992, 0x9C4A7D5D, 0x520E21D6, 0xB4712D92, 0xB865359B, 0x12097C78,
    0x2D702892, 0x958B5846, 0x520F4B20, 0xC8292892, 0x52326152, 0x55657FD4, 0x43542E12, 0x76324D3D,
    0x12121B4A, 0x75B27A30, 0xE8CD35A2, 0xF9EF09EB, 0x0D622E92, 0x5DA5B77E, 0x32136D76, 0x02136A28,
    0x72134A33, 0x7D842F92, 0x27C571C8, 0x2209742B, 0x74320F45, 0x371D1B54, 0x434A2C12, 0x02106A32,
    0xC8FB2F92, 0xB6F0F4C5, 0x74B22581, 0x1D2DFF18, 0x00A59AC1, 0x71320C45, 0x641D1B71, 0x43692912,
    0x32103A32, 0xA2432C92, 0xA056F0A3, 0x71B207E6, 0xB05D254A, 0xB4EA9BEC, 0x54652A29, 0x436D2F12,
    0x77325C32, 0x021D1B7D, 0x74B26A30, 0xC379D6F6, 0x62A73C9A, 0x13542F92, 0x46B0CFF4, 0x71B2E004,
    0xE817676E, 0x630A6D54, 0x71B26A29, 0xFBE4E309, 0xE36CFB83, 0x76B22A29, 0x0317122B, 0x2EAED858,
    0x72136A29, 0x76B26A33, 0x36400D0F, 0x6248D589, 0x12135A29, 0x02122992, 0xE4838EC1, 0x62088717,
    0x74B22A29, 0xCC7DF4C0, 0xFB5F9ACF, 0x70B25A33, 0xE0BCD65F, 0xC5D0F655, 0x71320F45, 0x671D1B6A,
    0x43742912, 0x02103A32, 0x05C52F92, 0x28AD50DE, 0x71B2B67A, 0x12A6DD18, 0x8672016D, 0x74B24A29,
    0x8FF7088E, 0x3CA22F74, 0x50656A29, 0x43672C12, 0x74326832, 0x321D1B7B, 0x70B22A30, 0xBF8AF7A0,
    0x9DF71548, 0x2FC22C92, 0x100B06A6, 0x76B2AE84, 0x26C6638A, 0x95A4A6F7, 0x70B25A29, 0x7BE4FF94,
    0xFD7885BD, 0x02094A28, 0x8E622D92, 0xB97C7A94, 0x576543E7, 0x43422D12, 0x75327F3D, 0x22121B5C,
    0x77B25A30, 0x14F05402, 0xC129B720, 0x4EEE2D92, 0x18C51723, 0x74B22265, 0x5D3AF698, 0xDCDE5C9D,
    0x55657A28, 0x43502F12, 0x77325D3D, 0x02121B4E, 0x75B27A30, 0x118C340B, 0x8AC26FB0, 0x05852F92,
    0xAD8ED796, 0x70B2970D, 0x8811266F, 0x95D24E95, 0x70B20A2F, 0x194C89B6, 0xE33AEA68, 0x32135A28,
    0xF5762D92, 0xF28E935F, 0x520FE1B6, 0x76320F45, 0x171D1B7F, 0x43632E12, 0x02104A32, 0x7CD22F92,
    0xAAD04922, 0x76B2293A, 0xFAAE1101, 0xA259ED88, 0xDE642E92, 0x388BEA59, 0x50650DD0, 0x43552912,
    0x71323832, 0x621D1B55, 0x70B22A30, 0xFE041977, 0x9EF3C266, 0xF4DF2992, 0xF5C2B6FA, 0x76B2B7C4,
    0xB5E41E3D, 0xAF5847A8, 0x70320D45, 0x751D1B57, 0x434B2812, 0x22102A32, 0xE9E42D92, 0x98BCC8F3,
    0x70B262B1, 0x4AF67C36, 0x96A7EDF8, 0x520F3A29, 0x75320E45, 0x26121B4B, 0x43572D12, 0x12107A3D,
    0x01442E92, 0x272A4BC2, 0x75B220D6, 0x44F6ECD8, 0x39225527, 0xF8A72892, 0xD7A3C289, 0x32133E94,
    0xC81F2F92, 0xDC0D23B9, 0x506518BD, 0x43542912, 0x71323832, 0x621D1B4A, 0x70B22A30, 0xCFCB4A53,
    0xA519C5AB, 0x12322992, 0xAF58B448, 0x77B2F5CF, 0x85F52DEB, 0x0658DD7B, 0x74B26A28, 0xDA088C04,
    0x4CE3503B, 0x40C76A20, 0x43442A12, 0x72321967, 0x54651B65, 0x9F391B61, 0xB4870EC2, 0x0ADE051C
]

payload_stage_3 = [
    0x44A8772B, 0x7C58C4BC, 0x211263BD, 0x675D4D16, 0x92D98DC0, 0x87A0DE25, 0x05FFC2BC, 0x07A7AB23,
    0x615DEDB1, 0x86A2C51E, 0xF636BBF8, 0x059EC0BC, 0x592944B4, 0x635D5D41, 0xB7C35D76, 0x33FB7572,
    0x61DDE06B, 0x02FDF67E, 0x54A1C33C, 0x35FFA713, 0x06E4C0BC, 0x22156E65, 0x615DE813, 0x6BB83A47,
    0xA1882997, 0x65FC9706, 0xEBA9C4BC, 0x7862FD70, 0x438AE435, 0x54A8C43C, 0x66DDD11C, 0x75F2F675,
    0x635D871E, 0x66C831D3, 0x66DAFFCB, 0xB2E8C4BC, 0xEDDCBEBB, 0x61DDC419, 0x05FFF64A, 0xF594C3BC,
    0xA69E199D, 0x625D6A17, 0xD27C415C, 0xD3E2A9BE, 0x60DDE46B, 0x16F2F664, 0x54BBC23C, 0x75FFB71C,
    0xCE35C4BC, 0xAD88B796, 0x605DB548, 0x5BBEF874, 0xB3FEA4CB, 0xABA3C4BC, 0x5397FBF0, 0x05E67BBD,
    0x62DDE26B, 0x30F2F641, 0x549CC03C, 0x15FF971C, 0xCC45C2BC, 0xA1575403, 0x625D8053, 0x35CE4FD7,
    0x4529B2A0, 0x2AC3C0BC, 0xC511C0F3, 0x05FCC74C, 0x478A9706, 0x5482C03C, 0x62DD951C, 0x35F2F653,
    0x675DC71E, 0x3E49E36B, 0xBB98F9D5, 0xD716C0BC, 0xED8444D2, 0x615D575A, 0x65843183, 0xF08655AD,
    0x438A8706, 0x54BEC53C, 0x67DDC113, 0x65FDF667, 0x635D871E, 0x2402D750, 0xC0290303, 0x09EBC5BC,
    0xBC13017C, 0x625D54BF, 0x97939437, 0xEBA7E573, 0x60DDE06B, 0x12FDF64A, 0x5495C23C, 0x35FFB713,
    0xCA33C0BC, 0x0AB195CE, 0x605D0952, 0xD5B2A040, 0xC06C15BF, 0x1857C2BC, 0xBA495C8B, 0x45E1C87D,
    0x63DDE36B, 0x21F2F66E, 0x54B1C13C, 0x05FF871C, 0x2520C3BC, 0x53525A07, 0x635D050F, 0xFF4742EA,
    0xF0468E44, 0x63DDE46B, 0x26F2F671, 0x54ACC13C, 0x75FF871C, 0x9273C4BC, 0x05288B62, 0x635D187F,
    0xE89F910B, 0xEC6885BA, 0x60A9C5BC, 0x3FA8CAE4, 0x428A363C, 0x5499C23C, 0x60DDB013, 0x15FDF646,
    0x625D971E, 0x574779E4, 0xBCF2E5CA, 0xD87CC2BC, 0x69B3C42F, 0x615DED0D, 0xB1A3F7E8, 0x5BB8E450,
    0x67DDE06B, 0x62F2F668, 0x54B7C53C, 0x35FFC71C, 0x5189C0BC, 0xF7338F57, 0x675D48D0, 0x46437556,
    0x46483A8B, 0x61DDE26B, 0x00FDF649, 0x5494C33C, 0x15FFA713, 0xFF43C2BC, 0x23461FE5, 0x615D05F4,
    0xF2410039, 0xAD9E7D17, 0x66DDE16B, 0x73FDF671, 0x54ACC43C, 0x25FFD713, 0x554AC1BC, 0xE80D2E25,
    0x665D2FBD, 0x180E3B45, 0x28D2CF36, 0xF58FC3BC, 0x7F0D99EB, 0x478A69C3, 0x5481C23C, 0x60DDB51C,
    0x15F2F65E, 0x675DC71E, 0x7BA0442E, 0x642EB4F6, 0xD838C2BC, 0x17DB9A9B, 0x428AC62C, 0x54A4C43C,
    0x66DDD013, 0x75FDF679, 0x625D971E, 0xCEF12824, 0x83AB42EB, 0x53FBC4BC, 0xF896D9EA, 0x635D9998,
    0xDF584F44, 0x950BEBB4, 0x75FCE700, 0x67DDE06B, 0x62F2F67A, 0x54A5C53C, 0x35FFC71C, 0x56E5C0BC,
    0x07F263EA, 0x675D612F, 0xBD755478, 0xE67310DA, 0xFCE7C3BC, 0x8085442A, 0x05E6056C, 0x61DDE46B,
    0x06FDF660, 0x54BFC33C, 0x75FFA713, 0x2817C4BC, 0x66577493, 0x615D0292, 0x0B87914C, 0x5CEFF405,
    0x229DC5BC, 0xF9F668A6, 0x05E69EE9, 0x7FE6C2BC, 0x39BA6FD4, 0x05E616F6, 0xDE4BC1BC, 0xB8158DB4,
    0x35E7B7FE, 0x615D9706, 0x0EA0FC96, 0x4B0D1924, 0x05FCD71D, 0xF16DC1BC, 0x7911AA0B, 0x418A40D5,
    0x5490C43C, 0x66DDD31C, 0x75F2F64D, 0x615DA71E, 0x0588A247, 0x1DE4151D, 0x6E2FC4BC, 0xB315FD5E,
    0x625DB767, 0x969A6460, 0xC2683F32, 0x67DDE46B, 0x66FDF67E, 0x54A1C53C, 0x75FFC713, 0x64B7C4BC,
    0xFFF71913, 0x675DD580, 0x2B9F0F1A, 0xB65E0A1A, 0x615DC707, 0x51CB1925, 0x240B8D0D, 0x65E78706,
    0x63DDE36B, 0x21FDF66D, 0x54B0C13C, 0x05FF8713, 0x9F69C3BC, 0x13BE9517, 0x635DDBFF, 0x165CEA3E,
    0x0001C4D1, 0xEC4BC3BC, 0xF2B9401F, 0x45E1705B, 0x665D9707, 0x73B24AFD, 0xD5B2E940, 0x35E68707,
    0x2158C2BC, 0x5024837A, 0x45E13223, 0x62DDE46B, 0x36FDF666, 0x54B9C03C, 0x75FF9713, 0x98F6C4BC,
    0x172F695B, 0x625D09F1, 0xE55F25F0, 0x8B2661DC, 0x625DB71D, 0x020D4179, 0xE24A2988, 0x25E7E700,
    0xA9A6C2BC, 0x1374E426, 0x05E6CD87, 0xA10FC0BC, 0x1C4760D0, 0x75E7A164, 0x05E6B707, 0xE31FC2BC,
    0x3B35B5AB, 0x15E662DF, 0x15FCE701, 0x438A8706, 0x5489C33C, 0x61DDA11C, 0x05F2F656, 0x635D871E,
    0xA7D956DA, 0x1201173F, 0xD36DC3BC, 0x6381B896, 0x05E72ED3, 0x5557C4BC, 0x89FCA143, 0x611D58CA,
    0x548AF64B, 0x615DA71E, 0xDB125CDF, 0xBB0A7DF5, 0x07DAC5BC, 0x5563CE4E, 0x45E12EEC, 0x8023C3BC,
    0xB5AC790C, 0x428A1D8D, 0x548AC53C, 0x67DDC013, 0x65FDF66B, 0x625D971E, 0x80220033, 0x8B77B74D,
    0x389CC5BC, 0x1EE51237, 0x45E1216C, 0x6773C3BC, 0x9939235B, 0x05FC7677, 0x62DDE56B, 0x37F2F656,
    0x5489C03C, 0x65FF971C, 0xFC58C5BC, 0x456F0643, 0x625DEC91, 0xFFF88A40, 0x74E5807A, 0x69E7C1BC,
    0xE777EE8F, 0x418A71D8, 0x54A1C03C, 0x62DD9313, 0x35FDF67E, 0x615DA71E, 0x3C007873, 0x14F8FF05,
    0xCEF3C0BC, 0xECA71F50, 0x635DB0DF, 0xE4E4FDF9, 0x358FE247, 0x65E7871D, 0x601D871D, 0x5CAAF64B,
    0x605DB71E, 0x7505AB4B, 0xD736CDD4, 0x15FDC4BC, 0xF36C63EF, 0x75FC6A39, 0x635DC707, 0xDB9219EE,
    0xECB077E1, 0x675DB707, 0xF7533B71, 0xD23F1B7B, 0x66DDE26B, 0x70F2F644, 0x549BC43C, 0x15FFD71C,
    0x122AC2BC, 0x3F42BDF0, 0x665D5B54, 0x05493036, 0x919DEC43, 0x635DA706, 0x9818E5A0, 0x2B4DC25A,
    0x65E68706, 0x1C4DC1BC, 0x197FA3CA, 0x75E62A33, 0x67DDE46B, 0x66FDF650, 0x548FC53C, 0x75FFC713,
    0xB05BC4BC, 0xCA72CEEA, 0x675D4876, 0x39EB8AFB, 0xD0785EBC, 0x54B7C2BC, 0x998D4CE8, 0x75FC97BA,
    0x45E1B707, 0x6486C1BC, 0x489751B5, 0x05FCEE18, 0x8F4DC0BC, 0x9B6785EB, 0x428A2AAC, 0x54B5C43C,
    0x66DDD01C, 0x75F2F66A, 0x625D971E, 0x5356F6DC, 0x54C9127A, 0xCF71C4BC, 0x4688EEA3, 0x15E6AC81,
    0x3DC6C1BC, 0x7B132484, 0x25E67D2C, 0xE299C0BC, 0xE5617E71, 0x45E00C98, 0x61DDE26B, 0x00F2F651,
    0x548CC33C, 0x15FFA71C, 0x6B3DC2BC, 0xBD3FA40C, 0x615DC414, 0xED41FC2F, 0xB5B600A6, 0xC98BC3BC,
    0x2F640777, 0x67DDE0FE, 0x65FFF64F, 0xE22DC5BC, 0xEF575AEA, 0x675D94B1, 0x04134075, 0xEAA527FD,
    0x75FC9706, 0xEA4EC4BC, 0xC29A9F7C, 0x45E040CF, 0x615DE701, 0x54AAF64B, 0x54A8F64B, 0x615DA71E,
    0x265A3503, 0xDA4CBD12, 0x023AC5BC, 0x6DEA5D2C, 0x478AF6C1, 0x548DC03C, 0x62DD951C, 0x35F2F652,
    0x675DC71E, 0xB4259B5F, 0x9656A0B2, 0x1AE8C0BC, 0x243C8C2C, 0x45E0D571, 0x3F56C1BC, 0x5B0E2B48,
    0x15E6D2E5, 0x0D16C1BC, 0xE0E51289, 0x468A43E8, 0x54A5C23C, 0x60DDB413, 0x15FDF67A, 0x665DD71E,
    0x7D111030, 0xE16C27B7, 0x92B4C2BC, 0x9F93B356, 0x438AA652, 0x548CC43C, 0x66DDD113, 0x75FDF651,
    0x635D871E, 0x24BC91E9, 0x9500C695, 0x11B5C4BC, 0xBCA1432B, 0x75E7EEF4, 0x89CDC0BC, 0x5C580B00,
    0x635DC6C8, 0xAE4F09E8, 0x33A264F1, 0x1228870E, 0x44A8772B, 0x54AAC13C, 0x5455C43C, 0x54AAC23C,
    0x54A2C33C, 0x5193C03C, 0x17F2E56B, 0x33E5D51F, 0x00E6C107, 0x17F2E56B, 0x33E5D51F, 0x00E6C107,
    0x17F2E56B, 0x33E5D51F, 0x00E6C107, 0x17F2E56B, 0x33E5D51F, 0x00E6C107, 0x17F2E56B, 0x33E5D51F,
    0x00E6C107, 0x17F2E56B, 0x33E5D51F, 0x00E6C107, 0x17F2E56B, 0x33E5D51F, 0x00E6C107, 0x17F2E56B,
    0x33E5D51F, 0x258AC107, 0x3BC8C1BC, 0xFECEB25A, 0x25EF6968, 0x65DDF5C9, 0x56A8F64A, 0x54AAC73C,
    0x54AEE16B, 0xCBB4C1A9, 0xB42E9BBE, 0x79F65E0C
]

payload_stage_4 = [
    0x4295EBDD, 0x7A65584A, 0x272FFF4B, 0x6160D1E0, 0x94E41136, 0x819D42D3, 0x03C25E4A, 0x019A37D5,
    0x67607147, 0x809F59E8, 0xF00B270E, 0x03A35C4A, 0x5F14D842, 0x6560C1B7, 0xB1FEC180, 0x35C6E984,
    0x67E07C9D, 0x04CF6A88, 0x529C5FCA, 0x33C23BEA, 0x00D95C4A, 0x2428F293, 0x676074E5, 0x6D85A6B1,
    0xA7B5B561, 0x65E07C9D, 0x24CF6AA0, 0x52B45DCA, 0x33C21BEA, 0xCFE25C4A, 0x08362970, 0x6560A76F,
    0x59ACD5BE, 0x40E94675, 0x42D5584A, 0xD2976ABD, 0x73C26ABD, 0xF3A9584A, 0xA0A3856B, 0x6460F6E1,
    0xD441DDAA, 0xD5DF3548, 0x64604BEB, 0x134AF022, 0x1194939F, 0x40B71BF0, 0x52B45ECA, 0x66E028EA,
    0x13CF6AA0, 0x60604BE8, 0x1250ABE4, 0xB23E2CCA, 0x55AA5E4A, 0xE880E74B, 0x64604CDE, 0xBA89FD0A,
    0xBCC02E52, 0x67600BF0, 0x0A7FC141, 0x33F3D321, 0x41B73BF0, 0x528E58CA, 0x60E049E5, 0x73C06A9A,
    0x61605BE8, 0x3F6E9D9C, 0xDF12D9A8, 0x0CC1584A, 0xE8A29774, 0x6160BD04, 0x7A2D270F, 0xE55FA588,
    0x60E07F9D, 0x77C06A9E, 0x528A58CA, 0x03C24BE5, 0x955F5F4A, 0xF1715B93, 0x6060CE91, 0xA7047BE4,
    0xD959FA55, 0x66E0799D, 0x11C06AA5, 0x52BF5ECA, 0x63C22BE5, 0xBA2E594A, 0x6E12C849, 0x66600BE8,
    0xCD3FE107, 0x80951FA1, 0x64600BEB, 0xBC10821F, 0x14E34F90, 0x66E07F9D, 0x17CF6AB4, 0x52A05ECA,
    0x03C22BEA, 0xB1635F4A, 0x5EB0FE7B, 0x66600A45, 0xF122AC79, 0x23291E01, 0x64E07E9D, 0x36CF6AAA,
    0x52BE5CCA, 0x13C20BEA, 0x28995E4A, 0x224B3EAC, 0x64608773, 0xC6EF88B5, 0xAAB51814, 0x73DB4BF1,
    0x66E0789D, 0x10CF6ABB, 0x52AD5ECA, 0x73C22BEA, 0xFDB0584A, 0x4D095BE6, 0x66604333, 0x9E0E81AF,
    0x2259BEB5, 0x64605BF1, 0x48ADCB88, 0x9A63A45B, 0x61607BF6, 0xFA4AC818, 0x8948B19B, 0x67605BF1,
    0xB88578FF, 0xB79E6B1E, 0x65600BF0, 0x63220718, 0x407EE9A0, 0x63DB7BF6, 0x257B584A, 0x05E29902,
    0x45B75427, 0x52AD5FCA, 0x67E03DE5, 0x03C06ABB, 0x65601BE8, 0x38866A01, 0x1E33A7B3, 0x6B555F4A,
    0xF9B2C0B7, 0x43DC3834, 0x47B77BF6, 0x529C5ECA, 0x66E02FE5, 0x13C06A88, 0x67603BE8, 0x88E0BD4C,
    0x7D9DD8D8, 0xDCAC5E4A, 0xDE057872, 0x6760066D, 0x7AE713E4, 0x386D9CF1, 0x67E07D9D, 0x05C06AA1,
    0x52B35FCA, 0x23C23BE5, 0x153C5D4A, 0xFF3F8618, 0x6760C8BF, 0xE7329756, 0xB20E8E62, 0xE7105D4A,
    0x881B6CEE, 0x41B7AC48, 0x52905CCA, 0x64E009EA, 0x33CF6A84, 0x61605BE8, 0xA1B0BE92, 0x5D4EB143,
    0xE3C45C4A, 0xC07FDAC6, 0x40B7EDEE, 0x52BC5FCA, 0x67E038E5, 0x03C06AA8, 0x60604BE8, 0xD04F1600,
    0xA64E5840, 0x35905F4A, 0x50D93590, 0x616062F8, 0xCC7A1C8A, 0x3A35C7E1, 0x66603BF1, 0xCB0841F1,
    0xB22A07AD, 0x60E07F9D, 0x77CF6A86, 0x529258CA, 0x03C24BEA, 0xD8765F4A, 0xBE281142, 0x60602B08,
    0x7B56964E, 0x7475380A, 0x63DB7BF6, 0x47045F4A, 0x43239943, 0x63DA0DEA, 0x73DB1BF0, 0x45B77BF6,
    0x528259CA, 0x61E05DE5, 0x63C06A96, 0x65601BE8, 0x5E518DFE, 0xBDCF5AA0, 0xC308594A, 0x510CFB9C,
    0x67603D4B, 0x42976ABD, 0x5397EA99, 0x67603BE8, 0xC51923BD, 0x72268468, 0x91C25E4A, 0x4EE27939,
    0x03DB284B, 0xCA045F4A, 0x5B5F4534, 0x73DB4BC4, 0x82ED584A, 0xDAE305AE, 0x63C1E7AF, 0xEBF25E4A,
    0x6C0F6D6C, 0x6160708E, 0x529768BD, 0x4297DABD, 0x61605BE8, 0x05709AE5, 0x6DD11E4E, 0x61E07E9D,
    0x66CF6A9A, 0x528E59CA, 0x13C25BEA, 0xFC805E4A, 0xABF3A598, 0x6160A860, 0xE477B57E, 0x7F414BBF,
    0x12C75E4A, 0x529762BD, 0x13C26ABC, 0x5D8E5E4A, 0xA5A3EE38, 0x67604443, 0x05B82250, 0x13110B8A,
    0x40B74BF0, 0x529859CA, 0x61E058E5, 0x63C06A8C, 0x60604BE8, 0x28A0E1D1, 0x36267BCA, 0x12CD594A,
    0xA6DA69D2, 0x46B7ADC7, 0x529B5DCA, 0x65E01EE5, 0x23C06A89, 0x66602BE8, 0xF91F447A, 0xE83D7833,
    0x1CB05D4A, 0x4C77C6A6, 0x45B71CAE, 0x52A45FCA, 0x67E03DEA, 0x03CF6AB0, 0x65601BE8, 0xE9A0D2AC,
    0xD860639B, 0xF2065F4A, 0xB3E399CE, 0x47B72C16, 0x528E59CA, 0x61E05FEA, 0x63CF6A9A, 0x67603BE8,
    0xDFE4780A, 0xD460ADC5, 0x3617594A, 0xE92805F3, 0x606062B2, 0xAAD90F41, 0xCF464626, 0x64E07D9D,
    0x35C06A86, 0x52925CCA, 0x23C20BE5, 0x58175D4A, 0xB6EA508B, 0x646034D5, 0x79F16E98, 0xF238E526,
    0x61E0789D, 0x60C06A95, 0x528F59CA, 0x73C25BE5, 0x861E584A, 0xB391E5FA, 0x6160817B, 0xB45E2F87,
    0x687AA5BB, 0x40B73BF0, 0x52AA5DCA, 0x65E018E5, 0x23C06ABE, 0x60604BE8, 0x9C791DA5, 0x56CB83F3,
    0x9C015D4A, 0x56D9D028, 0x47B7686D, 0x529258CA, 0x60E04FE5, 0x73C06A86, 0x67603BE8, 0xD2ABA72E,
    0x73754D42, 0x0286584A, 0x5762BE2C, 0x606091DC, 0xF9C516B6, 0x72D81C8C, 0x60601BF1, 0xEA3692D1,
    0xF2BE8A5B, 0x67605BEB, 0x12C563F3, 0x3F7CA980, 0x41B71BF0, 0x52865DCA, 0x65E019E5, 0x23C06A92,
    0x61605BE8, 0xBB8B5343, 0xE2D9610F, 0x44FD5D4A, 0x9C7B1FB8, 0x03DA4BB0, 0x67602BEB, 0x1DCA632D,
    0x84A96D40, 0x44B70BEB, 0x52815ECA, 0x66E02CE5, 0x13C06A97, 0x64600BE8, 0x51666EAE, 0x92372648,
    0xB2425E4A, 0xE7BB19B0, 0x13DBB5A8, 0x64E0799D, 0x31C06A83, 0x52955CCA, 0x63C20BE5, 0xF0BD594A,
    0x56E92B76, 0x64608AAC, 0x764764A5, 0xFF6CE730, 0x60E07F9D, 0x77C06A95, 0x528F58CA, 0x03C24BE5,
    0x397F5F4A, 0x4E93C7A2, 0x60603978, 0x79604F58, 0xD6141E21, 0x67E07C9D, 0x04C06ABB, 0x52AD5FCA,
    0x33C23BE5, 0xC7815C4A, 0x60B9E4DD, 0x6760353E, 0x7940501D, 0x6910154B, 0x1A705D4A, 0x1F423F3C,
    0x73DAB6C5, 0x66604BF1, 0x6A368E4C, 0xECAAF465, 0x13DA3BF0, 0x9FB05C4A, 0xA8AE0B4C, 0x13DB323F,
    0x66607BF6, 0x6B97313D, 0x2173767D, 0x67E0789D, 0x00C06ABB, 0x52AD5FCA, 0x73C23BE5, 0x2AFA584A,
    0x5469DA40, 0x6760951B, 0x8E70A570, 0x01910F8C, 0xBC5C594A, 0x2DF4E6D5, 0x03C17CAC, 0x61607BF7,
    0x089EF86E, 0xF2E89BB0, 0x45B72BEB, 0x52A658CA, 0x60E04DE5, 0x73C06AB2, 0x65601BE8, 0xDAADDC8E,
    0xA844DB76, 0xC86C584A, 0x28DD7CAC, 0x6660868A, 0xF0E490BD, 0xDDDFAAF4, 0x60605BF0, 0xB38B9C50,
    0x7C01CE09, 0x66E0789D, 0x10C06A97, 0x52815ECA, 0x73C22BE5, 0x6A59584A, 0x83D763BB, 0x66605899,
    0x306DD140, 0x4E570F65, 0xD297594A, 0x53972A2D, 0x63C26ABD, 0x35C4594A, 0xA40A630E, 0x73DABF5F,
    0x67607BF7, 0x56976ABD, 0x52952BB5, 0x67603BE8, 0x023028BC, 0x69240ED2, 0x60E07D9D, 0x75C06AB4,
    0x52A058CA, 0x23C24BE5, 0xB0145D4A, 0x45D4AB59, 0x60602AB6, 0x8B7BD15F, 0x7766FE5B, 0x65E07E9D,
    0x26C06ABB, 0x52AD5DCA, 0x13C21BE5, 0xD9CD5E4A, 0xCDDF5261, 0x65606965, 0x32AEACDB, 0x5BFA92AA,
    0x63DA0BF0, 0x44B74BEB, 0x52AF5DCA, 0x65E01CE5, 0x23C06AB5, 0x64600BE8, 0xBF6E2382, 0x2A6F9B53,
    0x5F715D4A, 0xC0C5F617, 0x6160F37C, 0x41D14731, 0x4032E051, 0x67602BF0, 0x53975ABD, 0x52976EBF,
    0x67603BE8, 0xDBA79176, 0xBB77AC02, 0xB3EB594A, 0x1AD9BF41, 0x23DA978C, 0x66604BF1, 0xBEC8775B,
    0xDAC6CEBF, 0x60607BF6, 0xB7B5A522, 0x3E14FB08, 0x63DB4BF1, 0x60E0799D, 0x71CF6A93, 0x528558CA,
    0x63C24BEA, 0x8027594A, 0x564F4E72, 0x6060388A, 0xCC9ED463, 0x6B7BBD56, 0x64E0789D, 0x30CF6AB4,
    0x52A05CCA, 0x73C20BEA, 0x9578584A, 0xBECA3D32, 0x6460E511, 0xD0C2107E, 0xBF96D977, 0xF8955D4A,
    0xF3A38420, 0x23D2ACEF, 0xD3F7143F, 0x60607ABE, 0x8B4B1F47, 0x1C8F626C, 0xCF09594A, 0x700396F5,
    0x66604444, 0x762498AF, 0xACB076AF, 0xCB735F4A, 0xE28F5CC3, 0x64602675, 0xD87BD46B, 0xBD7AC10C,
    0x48875D4A, 0x6D470480, 0x23DAAE2A, 0x61603BF0, 0x9A1FD63E, 0x8EA1572A, 0x33DA1BF0, 0x033E594A,
    0x8EE5433E, 0x73C11F6E, 0x66E0799D, 0x11CF6A82, 0x52965ECA, 0x63C22BEA, 0x4DE0594A, 0xA0852F9E,
    0x66605671, 0xEB438993, 0xC6B3B615, 0x66E07C9D, 0x14C06A8E, 0x529A5ECA, 0x33C22BE5, 0x419A5C4A,
    0xFB3EA1D8, 0x66603571, 0xAD6836D4, 0x111DFD9D, 0x23DA0BEB, 0x60603BF1, 0xB5CF983C, 0xC1677CF3,
    0x67602BF1, 0x94DFA693, 0x1DA282DA, 0x65E07E9D, 0x26CF6ABE, 0x52AA5DCA, 0x13C21BEA, 0x20A65E4A,
    0x75009F9E, 0x65605363, 0xC4892718, 0xEEEAF293, 0x65605BEB, 0x6D5F073F, 0x691D668F, 0x51151BF8,
    0x52965BCA, 0x63E068BF, 0x45B76ABD, 0x1C026AB9
]

# --------------------------------------------------------------------------------------------------
def decode_payload(payload, address, name, xorkey, offset=0):
    print "[+] Decoding payload at 0x%x ..." % address

    shutil.copyfile('ebc', name)
    with open(name, 'rb+') as fp:
        # start writing payload at 0x04006354
        fp.seek(0x554-offset, 0)

        for decb in [byte ^ xorkey for byte in payload]:
            fp.write(struct.pack("<L", decb))


# --------------------------------------------------------------------------------------------------
if __name__ == "__main__":
    print '[+] EBC payload decoder started.'

    # -------------------------------------------------------------------------
    xorkey = 0x06D35BCD
    print '[+] Initial XOR key: 0x%x' % xorkey

    decode_payload(payload_stage_1, 0x04007114, 'ebc_payload_1', xorkey)
    
    # -------------------------------------------------------------------------
    xorkey = zlib.crc32('EBC_1n7e')
    print '[+] Updating XOR key: 0x%x' % xorkey
    
    decode_payload(payload_stage_2, 0x040073dc, 'ebc_payload_2', xorkey)

    # -------------------------------------------------------------------------
    xorkey = zlib.crc32('rpret3r_')
    print '[+] Updating XOR key: 0x%x' % xorkey

    decode_payload(payload_stage_3, 0x04007b44, 'ebc_payload_3', xorkey)

    # -------------------------------------------------------------------------
    xorkey = zlib.crc32('1s_m4d3_')
    print '[+] Updating XOR key: 0x%x' % xorkey

    # Payload is too big and disassembler fails to parse all of it.
    # To fix that start overwriting 0x100 bytes before 0x4006354
    decode_payload(payload_stage_4, 0x0400837c, 'ebc_payload_4', xorkey, 0x100)

    print '[+] Program finished successfully.'

# --------------------------------------------------------------------------------------------------
'''
ispo@leet:~/ctf/tokyowesterns_ctf_2019/EBC$ ./ebc_decode_payload.py 
    [+] EBC payload decoder started.
    [+] Initial XOR key: 0x6d35bcd
    [+] Decoding payload at 0x4007114 ...
    [+] Updating XOR key: 0x43451b65
    [+] Decoding payload at 0x40073dc ...
    [+] Updating XOR key: 0x54aaf64b
    [+] Decoding payload at 0x4007b44 ...
    [+] Updating XOR key: 0x52976abd
    [+] Decoding payload at 0x400837c ...
    [+] Program finished successfully.
'''
# --------------------------------------------------------------------------------------------------
